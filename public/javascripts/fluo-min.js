
var FluoCanvas=function(){function toCanvas(o){if(o.getContext)
return o.getContext("2d");return o;}
function drawRoundedRect(c,x,y,width,height,radius){c.beginPath();c.moveTo(x,y+radius);c.lineTo(x,y+height-radius);c.quadraticCurveTo(x,y+height,x+radius,y+height);c.lineTo(x+width-radius,y+height);c.quadraticCurveTo(x+width,y+height,x+width,y+height-radius);c.lineTo(x+width,y+radius);c.quadraticCurveTo(x+width,y,x+width-radius,y);c.lineTo(x+radius,y);c.quadraticCurveTo(x,y,x,y+radius);c.stroke();}
function drawLineAndCurve(c,start,end,radius){var dir=(start[0]-end[0])<0?-1:1;c.beginPath();c.moveTo(start[0],start[1]);c.lineTo(end[0]+dir*radius,start[1]);c.quadraticCurveTo(end[0],start[1],end[0],end[1]);c.stroke();}
function drawPath(c,path,options){c=toCanvas(c);if(!options)options={};var rel=options['relative'];var fil=options['fill'];var color=options['color'];var i=0;var px=null;var py=null;c.beginPath();while(i<path.length){var x=path[i];var y=path[i+1];if(i==0){c.moveTo(x,y);}
else{if(rel){x=px+x;y=py+y;}
c.lineTo(x,y);}
px=x;py=y;i+=2;}
if(fil){if(color)c.fillStyle=color;c.fill();}
else{if(color)c.strokeStyle=color;c.stroke();}}
function drawArrow(c,start,delta,options){if(!options)options={};options['relative']=true;c=toCanvas(c);var l=6;var w=3;var dx=delta[0];var dy=delta[1];var path=start.concat(delta);drawPath(c,path,options);var tx=start[0]+dx;var ty=start[1]+dy;options['fill']=true;if(dx!=0){dx=dx<0?1:-1;path=[tx,ty,dx*-l,w,0,-w*2,dx*l,w];drawPath(c,path,options);}
else{dy=dy<0?1:-1;path=[tx,ty,-w,dy*l,w*2,0,w,dy*l];drawPath(c,path,options);}}
function newDownArrow(boxWidth){var w2=Math.floor(boxWidth/2);var h=10;var e=new Element("canvas",{"width":boxWidth,"height":h});if(!e.getContext)return e;var c=e.getContext("2d");drawArrow(c,[w2,0],[0,h]);return e;}
function newDownUpArrow(boxWidth){var w2=Math.floor(boxWidth/2);var h=10;var e=new Element("canvas",{"width":boxWidth,"height":h});if(!e.getContext)return e;var c=e.getContext("2d");drawArrow(c,[w2,0],[0,h]);drawArrow(c,[w2+7,h],[0,-h],{color:'rgba(0,0,0,0.3)'});return e;}
function drawSubprocessCross(c,w,h){var sz=14;var hsz=sz/2;var p=3;var w2=Math.floor(w/2);drawPath
(c,[w2-hsz,h-sz,w2+hsz,h-sz,w2+hsz,h,w2-hsz,h,w2-hsz,h-sz]);drawPath
(c,[w2,h-sz+p,w2,h-p]);drawPath
(c,[w2-hsz+p,h-hsz,w2+hsz-p,h-hsz]);}
function drawDiamond(c,w,h,sz){var w2=Math.floor(w/2);var h2=Math.floor(h/2);drawPath
(c,[w2,h2-sz,w2+sz,h2,w2,h2+sz,w2-sz,h2,w2,h2-sz]);}
function drawParaDiamond(c,w,h,sz){var w2=Math.floor(w/2);var h2=Math.floor(h/2);drawDiamond(c,w,h,sz);var sz=sz/2;c.lineWidth=2.5;drawPath
(c,[w2,h2-sz,w2,h2+sz]);drawPath
(c,[w2-sz,h2,w2+sz,h2]);c.lineWidth=1;}
function asCanDiv(container,width,height){var wh="width: "+width+"; height: "+height+";";var pos="position: absolute;"
container.setStyle({"width":width,"height":height});var ie=new Element("div",{id:"inside_"+container.id,style:wh+pos});var ic=new Element("canvas",{"id":"canvas_"+container.id,"width":width,"height":height,"style":pos});container.appendChild(ie);container.appendChild(ic);container.div=ie;container.canvas=ic;}
function asCenteredBox(container,totalWidth,boxWidth,boxHeight,variant){asCanDiv(container,totalWidth,boxHeight);var ie=container.div;var ic=container.canvas;if(!ic.getContext)return ie;var ww2=(totalWidth-boxWidth)/2;var ctx=ic.getContext("2d");drawRoundedRect(ctx,ww2,1,boxWidth,boxHeight-2,10);if(variant=="subprocess"){drawSubprocessCross(ctx,totalWidth,boxHeight);}
return ie;}
function newBox(container,width,height){return newCenteredBox(container,width,width,height);}
function newConcurrenceOpening(width,count){var h=34;var e=new Element("canvas",{"width":width,"height":h});if(!e.getContext)return e;var c=e.getContext("2d");drawParaDiamond(c,width,24,12);var w=width/count;var w2=w/2;for(var i=0;i<count;i++){drawArrow(c,[i*w+w2,24],[0,10]);var start=-12;if(i+1>count/2)start=-start;if(count%2==1&&Math.floor(count/2)==i)continue;drawLineAndCurve
(c,[width/2+start,12],[i*w+w2,24],10);}
return e;}
function newConcurrenceClosing(width,count){var h=11;var e=new Element("canvas",{"width":width,"height":h});if(!e.getContext)return e;var c=e.getContext("2d");var w=width/count;var w2=w/2;drawLineAndCurve
(c,[width/2,h-1],[w2,0],10);drawLineAndCurve
(c,[width/2,h-1],[width-w2,0],10);return e;}
function newIfOpening(width){var h=25;var e=new Element("canvas",{"width":width,"height":h});if(!e.getContext)return e;var c=e.getContext("2d");drawDiamond(c,width,24,12);drawLineAndCurve
(c,[width/2-12,12],[width/4,24],10);drawLineAndCurve
(c,[width/2+12,12],[width*3/4,24],10);return e;}
function drawIfLines(canvas,hasElse){var h=canvas.height;var W=canvas.width;w=[W/4,W*3/4];drawArrow(canvas,[w[0],0],[0,h]);if(hasElse)
drawArrow(canvas,[w[1],0],[0,h]);else
drawPath(canvas,[w[1],0,w[1],h]);}
return{toCanvas:toCanvas,drawRoundedRect:drawRoundedRect,drawLineAndCurve:drawLineAndCurve,drawPath:drawPath,drawArrow:drawArrow,newDownArrow:newDownArrow,newDownUpArrow:newDownUpArrow,drawSubprocessCross:drawSubprocessCross,drawDiamond:drawDiamond,drawParaDiamond:drawParaDiamond,asCanDiv:asCanDiv,asCenteredBox:asCenteredBox,newBox:newBox,newConcurrenceOpening:newConcurrenceOpening,newConcurrenceClosing:newConcurrenceClosing,newIfOpening:newIfOpening,drawIfLines:drawIfLines};}();

var Fluo=function(){function tdiv(text){var attributes={};if(tdiv.arguments.length>1)attributes=tdiv.arguments[1];if((typeof text=='string')&&text.match(/(u[a-fA-F0-9]{4})+/)){var ss=text.split("u");text="";for(var i=0;i<ss.length;i++){text+=String.fromCharCode(parseInt(ss[i],16));}}
var e=new Element("div",attributes);e.appendChild(document.createTextNode(text));return e;}
function divClear(){var e=new Element('div',{style:"clear: both;"});if(divClear.arguments.length>0)divClear.arguments[0].appendChild(e);return e;}
function newDiv(){var attributes={};if(newDiv.arguments.length==2){attributes["id"]=newDiv.arguments[0];attributes["class"]=newDiv.arguments[1];}
else{attributes["class"]=newDiv.arguments[0];}
return new Element("div",attributes);}
var Expression=Class.create({initialize:function(container,exp_id,array,desired_width){this.container=container;this.exp_id=exp_id;this.exp_name=array[0];this.exp_attributes=$H(array[1]);this.exp_children=array[2];this.desired_width=desired_width;this.div=newDiv(this.exp_id,this.cssPrefix());this.div.fluo_exp=this;this.setContentDiv(this.div);this.container.appendChild(this.div);this.render();},setContentDiv:function(div){this.content_div=div;this.content_div.fluo_exp=this;},render:function(){this.renderHead();this.renderChildren();this.renderFoot();},renderHead:function(){var eDiv=newDiv(this.cssPrefix()+"_head");eDiv.appendChild(tdiv(this.exp_name));this.exp_attributes.each(function(att){eDiv.appendChild(tdiv(""+att.key+" : "+att.value));});this.content_div.appendChild(eDiv);},renderFoot:function(){},renderChildren:function(){for(var i=0;i<this.exp_children.length;i++){child=this.exp_children[i];if((!this.getFluoContainer().showMinorExpressions)&&MINOR_EXPRESSIONS.include(child[0])){continue;}
this.renderChild(i,child);}},renderChild:function(index,child){var container=this.content_div;if(arguments.length>2)container=arguments[2];return renderExpression
(container,this.exp_id+"."+index,child,this.desired_width);},cssName:function(){return"base";},cssPrefix:function(){return"fluo_exp_"+this.cssName();},fetchAttribute:function(attname){var v=this.exp_attributes.get(attname);if(v!=null)return v;v=this.exp_attributes.get("field-"+attname);if(v!=null)return"field : "+v;v=this.exp_attributes.get("variable-"+attname);if(v!=null)return"variable : "+v;return null;},fetchText:function(){return this.exp_children[0];},getFluoContainer:function(){var id=this.content_div.id;var i=id.indexOf(ROOT_EXP_ID);id=id.substring(0,i);return $(id);},attMaxSize:function(){var max=this.exp_name.length;this.exp_attributes.each(function(e){var l=e.key.length+e.value.length;if(l>max)max=l;});return max;},renderBox:function(width,height,variant){var ie=FluoCanvas.asCenteredBox
(this.div,this.desired_width||this.div.scrollWidth,width,height,variant);this.setContentDiv(ie);}});var SequenceExpression=Class.create(Expression,{cssName:function(){return"sequence";},renderHead:function($super){if(this.exp_name!='sequence'){var eDiv=newDiv(this.cssPrefix()+"_centered_head");eDiv.appendChild(tdiv(this.exp_name));this.content_div.appendChild(eDiv);}},renderChild:function($super,index,child){var ce=$super(index,child);ssw=this.content_div.scrollWidth;if(child==this.exp_children.last())return;if(this.exp_name=='cursor'||this.exp_name=='loop')
var dArrow=FluoCanvas.newDownUpArrow(ssw||this.desired_width);else
var dArrow=FluoCanvas.newDownArrow(ssw||this.desired_width);this.content_div.appendChild(dArrow);}});var ConcurrenceExpression=Class.create(Expression,{cssName:function(){return"concurrence";},horizontalBar:function(){var eBar=new Element('div',{"class":"fluo_pixel"});eBar.setStyle({"width":"70%","height":"2px"});return eBar;},renderHead:function($super){if(this.exp_name!="concurrence")$super();},renderChildren:function(){this.content_div.appendChild
(FluoCanvas.newConcurrenceOpening
(this.content_div.scrollWidth,this.exp_children.length));var eChildren=new Element('div',{"class":"fluo_exp_concurrence_children"});var width=this.div.scrollWidth/this.exp_children.length;width=Math.floor(width)-3;for(var i=0;i<this.exp_children.length;i++){var child=this.exp_children[i];var eChild=newDiv("fluo_exp_concurrence_child");eChild.setStyle({"width":""+width+"px"});eChildren.appendChild(eChild);renderExpression(eChild,this.exp_id+"."+i,child,width);}
this.content_div.appendChild(eChildren);this.content_div.appendChild(divClear());this.content_div.appendChild
(FluoCanvas.newConcurrenceClosing
(this.content_div.scrollWidth,this.exp_children.length));}});var ProcessDefinitionExpression=Class.create(Expression,{initialize:function($super,container,exp_id,array,desired_width){$super(container,exp_id,array,desired_width);this.process_definition=array;},cssName:function(){return"process_definition";},renderHead:function(){var eHead=newDiv('fluo_exp_pdef_head');this.content_div.appendChild(eHead);var pdef=this.exp_attributes.get('name');if(!pdef)pdef=this.exp_children[0];var rev=this.exp_attributes.get('revision');if(rev)pdef=pdef+" (rev "+rev+")";var ePdef=newDiv();ePdef.appendChild(tdiv(pdef));eHead.appendChild(ePdef);this.exp_children.each(function(child){if(child[0]=='description'){var eDesc=newDiv();var eItal=new Element("i");eItal.appendChild(tdiv(child[2][0]));eDesc.appendChild(eItal);eHead.appendChild(eDesc);}});},renderChildren:function($super){var a=new Array();for(var i=0;i<this.exp_children.length;i++){var child=this.exp_children[i];if(typeof child=='string')continue;if(child[0]=='description')continue;a.push(child);}
this.exp_children=a;$super();}});var NoChildrenExpression=Class.create(Expression,{renderChildren:function(){}});var UnknownExpression=Class.create(NoChildrenExpression,{cssName:function(){return"unknown";},render:function(){var width=this.attMaxSize()*7+35;if(width>this.desired_width)width=this.desired_width-1;var height=this.exp_attributes.size()*21+25;this.renderBox(width,height,null);this.renderHead();}});var OneLineExpression=Class.create(NoChildrenExpression,{cssName:function(){return"oneline";},render:function(){this.renderHead();},renderHead:function(){var eDiv=newDiv(this.cssPrefix()+"_head");var text=this.exp_name;this.exp_attributes.each(function(att){text+=("  "+att.key+": '"+att.value+"'");});eDiv.appendChild(document.createTextNode(text));this.content_div.appendChild(eDiv);}});var ParticipantExpression=Class.create(NoChildrenExpression,{cssName:function(){return"participant";},render:function(){var width=this.attMaxSize()*5+35;if(width>this.desired_width)width=this.desired_width-1;att_count=this.exp_attributes.size()-1;if(att_count<0)att_count=0;if(this.determineActivity())att_count+=1;var height=25+17*att_count;this.renderBox(width,height,null);this.renderHead();},renderHead:function(){var eDiv=newDiv(this.cssPrefix()+"_head");var ref=this.fetchAttribute('ref');if(!ref)ref=this.fetchText();if(!ref)ref=this.exp_name;var activity=this.determineActivity();eDiv.appendChild(tdiv(ref));if(activity)eDiv.appendChild(tdiv(activity));this.content_div.appendChild(eDiv);},determineActivity:function(){return this.exp_attributes.get('activity')||this.exp_attributes.get('tag');}});var SubprocessExpression=Class.create(ParticipantExpression,{cssName:function(){return"subprocess";},render:function(){var width=130;var height=40;this.renderBox(width,height,"subprocess");this.renderHead();}});var CaseExpression=Class.create(Expression,{cssName:function(){return"case";},renderHead:function(){var eDiamond=new Element("img",{"src":"/images/fluo/diamond.png"});this.content_div.appendChild(eDiamond);this.content_div.appendChild(document.createTextNode(this.exp_name));this.content_div.appendChild(divClear());},renderChildren:function(){var consequence=false;for(var i=0;i<this.exp_children.length;i++){var child=this.exp_children[i];if(i==this.exp_children.length-1&&(!consequence))
consequence=true;if(consequence){this.renderConsequence(i,child);this.content_div.appendChild(divClear());}
else{this.renderCondition(i,child);}
consequence=(!consequence);}},renderFoot:function(){var eDiamond=new Element("img",{"src":"/images/fluo/diamond.png"});this.content_div.appendChild(eDiamond);},renderCondition:function(index,item){var e=newDiv(this.cssPrefix()+"_condition");this.renderChild(index,item,e);this.content_div.appendChild(e);},renderConsequence:function(index,child){var e=newDiv(this.cssPrefix()+"_consequence");this.renderChild(index,child,e);this.content_div.appendChild(e);var earrow=newDiv(this.cssPrefix()+"_arrow");earrow.appendChild(new Element("img",{"src":"/images/fluo/aright.png"}));this.content_div.appendChild(earrow);}});var IfExpression=Class.create(Expression,{cssName:function(){return"if";},render:function(){this.renderChildren();},renderChildren:function(){var w=this.content_div.scrollWidth||this.desired_width;var w2=Math.round(w/2);var offset=1;var aTest=this.exp_attributes.get('test');var cCondition=this.exp_children[0];if(aTest){offset=0;cCondition=aTest;}
var cThen=this.exp_children[0+offset];var cElse=this.exp_children[1+offset];this.content_div.appendChild(FluoCanvas.newIfOpening(w));this.renderCondition(cCondition,(cElse!=null));var eBody=new Element("div");var tw=w2+1;var ew=w2-2;var eThen=newDiv(this.cssPrefix()+"_then");var eElse=newDiv(this.cssPrefix()+"_else");eThen.setStyle("width: "+tw+"px");eElse.setStyle("width: "+ew+"px");eBody.appendChild(eThen);eBody.appendChild(eElse);if(cThen){this.desired_width=tw;eThen.appendChild(tdiv("then",{style:"text-align: center;"}));this.renderChild(0+offset,cThen,eThen);}
if(cElse){this.desired_width=ew;eElse.appendChild(tdiv("else",{style:"text-align: center;"}));this.renderChild(0+offset,cElse,eElse);}
this.content_div.appendChild(divClear());this.content_div.appendChild(eBody);if(cElse==null){var eew=Math.round(ew/2)-1;var h=eThen.scrollHeight||15;var c=new Element("canvas",{width:ew,height:h});FluoCanvas.drawPath(c,[eew,0,eew,h]);eElse.appendChild(c);}
this.content_div.appendChild(FluoCanvas.newConcurrenceClosing(w,2));},renderCondition:function(item,hasElse){var e=newDiv(this.cssPrefix()+"_condition");var height=60;if(typeof item=='string')height=20;FluoCanvas.asCanDiv
(e,this.desired_width||this.content_div.scrollWidth,height);FluoCanvas.drawIfLines(e.canvas,hasElse);if(typeof item=='string')
e.div.appendChild(tdiv(item,{style:"text-align: center"}));else
this.renderChild(0,item,e.div);this.content_div.appendChild(e);}});var ROOT_EXP_ID="_exp_0";var EXPRESSIONS={"case":CaseExpression,"concurrence":ConcurrenceExpression,"cursor":SequenceExpression,"define":ProcessDefinitionExpression,"defined":OneLineExpression,"equals":Expression,"if":IfExpression,"loop":SequenceExpression,"process-definition":ProcessDefinitionExpression,"sequence":SequenceExpression,"participant":ParticipantExpression,"reval":OneLineExpression,"set":OneLineExpression,"set-fields":Expression,"sleep":OneLineExpression,"subprocess":SubprocessExpression,"unset":OneLineExpression,"workflow-definition":ProcessDefinitionExpression,}
var MINOR_EXPRESSIONS=$A(["set","unset","set-fields"])
function toggleMinorExpressions(parent){parent=$(parent);parent.showMinorExpressions=!parent.showMinorExpressions;renderExpression(parent,null,parent.process_definition);return false;}
function collectProcessNames(pdef){var result=[];if(pdef==null)return result;var exp_name=pdef[0];var attributes=pdef[1];var children=pdef[2];if(exp_name=='process-definition'){result.push(attributes['name']);}
if(children){for(var i=0;i<children.length;i++)
result=result.concat(collectProcessNames(children[i]));}
return result;}
function isSubprocess(parent,name){if(parent==null||(!parent.fluo_exp))return false;var pnames=parent.fluo_exp.getFluoContainer().process_names;return(pnames.indexOf(name)>-1);}
function renderExpression(parent,exp_id,a){var desiredWidth=arguments[3];parent=$(parent);var top=(exp_id==null);if(top){exp_id=parent.id+ROOT_EXP_ID;parent.childElements().each(function(elt){elt.remove();});parent.process_definition=a;parent.process_names=collectProcessNames(a);}
var exp_name=a[0];var clazz=EXPRESSIONS[exp_name];if(clazz==null){if(isSubprocess(parent,exp_name))
clazz=SubprocessExpression;else
clazz=UnknownExpression;}
var result=new clazz(parent,exp_id,a,desiredWidth);if(top){if(parent.taggedExpressions){tagExpressionsWithWorkitems(parent,parent.taggedExpressions);}}
return result;}
function tagExpressionsWithWorkitems(root,expression_ids){root=$(root);var root_id=root.getAttribute("id");expression_ids=$A(expression_ids);expression_ids.each(function(exp_id){markExpression($(root_id+"_exp_"+exp_id));});root.taggedExpressions=expression_ids;}
function markExpression(e){if(!e)return;var marker=$("marker_"+e.id);if(!marker){marker=new Element
("div",{"id":"marker_"+e.id,"class":"fluo_marker"});marker.appendChild(document.createTextNode("workitem"));document.body.appendChild(marker);}
var l=e.offsetLeft+e.offsetWidth/1.82;var t=e.offsetTop+e.offsetHeight/2.09;marker.setStyle({"left":""+Math.floor(l)+"px"});marker.setStyle({"top":""+Math.floor(t)+"px"});}
return{renderExpression:renderExpression,toggleMinorExpressions:toggleMinorExpressions,tagExpressionsWithWorkitems:tagExpressionsWithWorkitems};}();
